# 基于 C++17 + 独立版 Asio 的 RTSP 流录制系统 设计文档

## 一、系统概述

### 1. 核心目标
本系统旨在构建一套**无 Boost 依赖**、基于 C++17 标准（无协程）、采用独立版 Asio 的工业级流媒体录制系统，具备以下核心特性：
- **多协议输入**：支持 RTSP 1.0/1.1/2.0 及 RTMP、HLS、SRT 等扩展协议
- **高可靠性**：7x24 小时稳定运行，异常场景下文件可恢复率 ≥95%
- **可扩展性**：通过插件化架构支持协议、编解码、存储后端的动态扩展
- **易运维性**：支持配置热更新、完善的监控指标与故障排查工具
- **跨平台部署**：兼容 Linux、Windows、macOS，支持容器化与集群部署

## 二、整体架构设计

### 1. 架构分层
系统采用三层架构设计，各层职责清晰且解耦：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        外部交互层                                   │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │
│  │ 多协议媒体源   │  │ 配置管理工具   │  │ 监控/API 客户端      │   │
│  │ (RTSP/RTMP等)  │  │  (YAML/热更新) │  │  (HTTP/gRPC)         │   │
│  └───────────────┘  └───────────────┘  └───────────────────────┘   │
└───────────────────────────┬─────────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────────┐
│                        核心服务层                                   │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │
│  │ 媒体处理模块   │  │ 录制控制模块   │  │ 存储管理模块          │   │
│  │ (解封装/同步)  │  │ (策略/分段)    │  │ (多后端/加密)         │   │
│  └───────────────┘  └───────────────┘  └───────────────────────┘   │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │
│  │ 插件管理模块   │  │ 接口服务模块   │  │ 监控日志模块          │   │
│  │ (动态加载)     │  │ (HTTP/gRPC)    │  │ (指标/日志)           │   │
│  └───────────────┘  └───────────────┘  └───────────────────────┘   │
└───────────────────────────┬─────────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────────┐
│                        存储层                                       │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │
│  │ 媒体文件      │  │ 索引文件      │  │ 加密密钥 (KMS)       │   │
│  │ (MP4/MKV/TS)  │  │ (.idx)        │  │                      │   │
│  └───────────────┘  └───────────────┘  └───────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. 核心技术栈
| 技术领域         | 选型方案                                  | 版本要求                  |
|------------------|-------------------------------------------|---------------------------|
| 编程语言         | C++17 (无协程)                            | GCC 7+/Clang 5+/MSVC 2017+|
| 网络库           | 独立版 Asio (无 Boost 依赖)               | 1.28.0+                   |
| 媒体处理         | FFmpeg (解封装/封装)                      | 5.0+                      |
| 配置解析         | yaml-cpp                                  | 0.7.0+                    |
| 日志格式化       | fmt                                       | 8.0+                      |
| 加密库           | OpenSSL (TLS/加密)                        | 1.1.1+                    |
| 并发队列         | moodycamel::ConcurrentQueue               | 最新稳定版                |
| 构建工具         | CMake                                     | 3.15+                     |

## 三、模块详细设计

### 1. 媒体源模块（MediaSource）
#### 1.1 功能概述
实现多协议输入抽象，支持 RTSP、RTMP、HLS、SRT 等协议的媒体流接收与解析。

#### 1.2 核心接口
```cpp
class MediaSource {
public:
    virtual ~MediaSource() = default;
    virtual bool connect(const std::string& url, const AuthInfo& auth) = 0;
    virtual void disconnect() = 0;
    virtual bool read_packet(AVPacketPtr& packet) = 0;  // AVPacket智能指针封装
    virtual MediaMetadata get_metadata() const = 0;     // 音视频编码信息
    virtual void set_timeout(std::chrono::milliseconds timeout) = 0;
};
```

#### 1.3 插件化实现
- 协议插件通过 `extern "C"` 导出创建/销毁函数：
  ```cpp
  extern "C" MediaSource* create_source();
  extern "C" void destroy_source(MediaSource*);
  ```
- 主程序通过 `dlopen`/`LoadLibrary` 动态加载，注册至 `MediaSourceManager`。

### 2. 媒体处理模块（MediaProcessor）
#### 2.1 功能概述
负责音视频同步、时间戳校准、可选转码及预览流生成。

#### 2.2 关键实现
- **时间戳校准**：基于 RTCP NTP 时间或协议绝对时间戳，通过 `std::chrono::duration` 转换为统一时间轴。
- **音视频同步**：计算音视频时间戳差值，通过 `std::atomic` 原子变量跟踪同步误差（<40ms）。
- **预览流生成**：
  - 低延迟转发（RTSP over TCP）或共享内存输出（YUV 格式）
  - 预览延迟 <300ms，通过独立线程池处理，不影响主录制流

### 3. 录制控制模块（RecorderController）
#### 3.1 功能概述
管理录制策略（手动/定时/分段）、异常恢复及热更新协调。

#### 3.2 核心功能
- **定时录制**：基于 Cron 表达式解析库，支持分钟级精度调度。
- **分段管理**：双阈值触发（时间/大小），通过 `std::filesystem` 管理文件路径。
  ```cpp
  // 分段条件判断示例
  bool should_segment() {
      return (current_duration >= segment_duration) || 
             (current_size >= segment_size);
  }
  ```
- **异常恢复**：通过 `.idx` 索引文件记录关键帧位置与 PTS，恢复成功率 ≥95%。

### 4. 存储管理模块（StorageManager）
#### 4.1 功能概述
实现多存储后端适配与混合存储策略，支持本地文件系统、对象存储、NAS。

#### 4.2 存储接口设计
```cpp
class StorageSink {
public:
    virtual ~StorageSink() = default;
    virtual bool write(const uint8_t* data, size_t size, int64_t pts) = 0;
    virtual bool read(uint8_t* data, size_t size, int64_t offset) = 0;
    virtual bool delete_file(const std::string& path) = 0;
    virtual uint64_t get_free_space() const = 0;
};
```

#### 4.3 混合存储策略
- 实时录制先写入本地 SSD 缓存（`std::async` 异步提交）
- 空闲时通过线程池异步上传至对象存储（分片上传，默认 8MB/片）
- `.idx` 索引文件记录本地与云端片段映射关系

### 5. 插件管理模块（PluginManager）
#### 5.1 功能概述
负责协议、编解码、存储插件的动态加载、版本管理与热更新。

#### 5.2 热更新机制
- 新插件加载后生成版本号隔离的实例
- 通过消息总线平滑切换至新实例
- 旧实例在当前分片完成后通过 `std::unique_ptr` 自动释放

### 6. 接口服务模块（ApiServer）
#### 6.1 功能概述
基于独立版 Asio 实现 HTTP/HTTPS 与 gRPC 服务，提供 REST API 接口。

#### 6.2 核心接口
- 录制控制：`POST /api/v1/record/{stream_id}/start`
- 状态查询：`GET /api/v1/stream/{stream_id}/status`
- 配置更新：`PUT /api/v1/config`
- 文件管理：`GET /api/v1/files`、`DELETE /api/v1/file/{file_id}`
- 指标查询：`GET /metrics`（Prometheus 格式）

#### 6.3 安全机制
- TLS 1.3 加密传输
- API Key 认证
- 请求参数合法性校验

### 7. 监控与日志模块（Monitor & Log）
#### 7.1 日志系统
- 五级分级（TRACE/DEBUG/INFO/WARN/ERROR），基于 `fmt::format` 优化
- 异步落盘（`std::queue` + 独立线程 + `std::condition_variable`）

#### 7.2 指标监控
- 核心指标：码率、帧率、丢包数、存储使用率、录制状态等
- 基于 `std::atomic` 累计指标，通过 HTTP 服务暴露 Prometheus 格式数据

## 四、核心技术实现

### 1. 网络与并发
- **异步 IO**：基于独立版 Asio 的回调式模型，TCP 用 `asio::ip::tcp::socket`，UDP 用 `asio::ip::udp::socket`
- **线程模型**：每路流分配独立 `asio::io_context + 工作线程`，核心模块共享线程池
- **超时控制**：`asio::steady_timer` 实现连接/接收超时，支持动态配置阈值
- **无锁队列**：`moodycamel::ConcurrentQueue` 作为 AVPacket 缓存通道，解耦生产者与消费者

### 2. 内存管理
- **智能指针封装**：自定义 `AVPacketPtr`/`AVFramePtr`，通过删除器自动释放 FFmpeg 资源
  ```cpp
  using AVPacketPtr = std::unique_ptr<AVPacket, decltype(&av_packet_free)>;
  AVPacketPtr create_packet() {
      return AVPacketPtr(av_packet_alloc(), &av_packet_free);
  }
  ```
- **内存对齐**：`std::aligned_alloc` 分配 32 字节对齐缓存，优化 SIMD 处理效率
- **配置安全**：`std::shared_mutex` 保护配置数据，读共享、写独占

### 3. 加密与安全
- **传输加密**：基于 Asio SSL 模块实现 TLS 1.3
- **文件加密**：AES-128-CBC 或国密 SM4，密钥通过 KMS 管理（`std::unique_ptr` 保护密钥内存）
- **认证机制**：支持 RTSP Digest、RTMP Token、API Key 等多维度认证

## 五、部署与运维

### 1. 编译部署
- **环境要求**：Linux（Ubuntu 18.04+/CentOS 7+）、Windows 10+、macOS 12+
- **编译命令**：
  ```bash
  mkdir build && cd build
  cmake -DCMAKE_BUILD_TYPE=Release ..
  make -j$(nproc)  # Linux/macOS
  # Windows：通过 Visual Studio 编译
  ```
- **部署包内容**：可执行文件 + 配置模板 + 插件目录 + 运维工具

### 2. 容器化部署
- 基于 Alpine 基础镜像，体积 ≤60MB
- 启动时间 ≤3s
- 支持 Kubernetes DaemonSet/Deployment 部署

### 3. 运维工具
- `rtsp-probe`：流地址探测与媒体信息解析
- `record-repair`：损坏文件修复工具（基于 `.idx` 索引）
- `config-validator`：配置文件合法性校验
- 监控面板：Prometheus + Grafana 可视化录制状态与资源占用

## 六、测试与验收标准

### 1. 功能测试
- 协议兼容性：支持 RTSP/RTMP/HLS/SRT 混合输入
- 媒体格式：正确处理 H.264/H.265 视频，AAC/G.711 音频
- 录制策略：手动/定时/分段录制功能正常，状态切换无异常

### 2. 性能测试
- 并发能力：8 核 CPU 支持 ≥16 路 1080p@30fps 录制，CPU 占用 ≤70%
- 资源占用：每路流内存 ≤150MB，72 小时内存增长 ≤5%
- IO 性能：本地写盘延迟 ≤1s，对象存储上传成功率 ≥99.9%

### 3. 可靠性测试
- 稳定性：7x24 小时连续运行无崩溃
- 恢复能力：断流重连成功率 100%，异常文件修复率 ≥95%
- 兼容性：支持主流操作系统与存储后端

## 七、项目结构说明

为了更好地组织代码和便于维护，项目采用模块化结构：

```
.
├── BUILD_INSTRUCTIONS.md          # 构建说明文档
├── CMakeLists.txt                 # CMake 构建配置文件
├── PROJECT_STRUCTURE.md           # 项目结构说明
├── conanfile.txt                  # Conan 依赖配置文件
├── config/                        # 配置文件目录
│   └── config.yaml                # 示例配置文件
├── cmake/                         # CMake 配置文件目录
├── docs/                          # 项目文档目录
│   ├── 开发周计划.md               # 开发计划文档
│   ├── 设计需求.md                 # 项目需求分析文档
│   └── 软件设计.md                 # 软件设计文档
├── include/                       # 头文件目录
│   ├── config_manager.h           # 配置管理器头文件
│   ├── media_source.h             # 媒体源接口定义
│   ├── plugin_manager.h           # 插件管理器接口定义
│   ├── recorder_controller.h      # 录制控制器接口定义
│   └── storage_manager.h          # 存储管理器接口定义
├── plugins/                       # 插件源码目录
│   ├── rtsp/                      # RTSP协议插件
│   │   └── rtsp_source.cpp        # RTSP协议插件实现
│   ├── rtmp/                      # RTMP协议插件（预留）
│   └── srt/                       # SRT协议插件（预留）
├── src/                           # 源代码目录
│   ├── core/                      # 核心模块
│   │   ├── main.cpp               # 主程序入口
│   │   ├── config_manager.cpp     # 配置管理器实现
│   │   └── recorder_controller.cpp # 录制控制器实现
│   ├── storage/                   # 存储模块
│   │   └── local_storage.cpp      # 本地存储后端实现
│   ├── media/                     # 媒体处理模块（预留）
│   ├── api/                       # 接口服务模块（预留）
│   └── utils/                     # 工具模块（预留）
├── scripts/                       # 脚本目录
├── tests/                         # 测试代码目录
└── build/                         # 构建输出目录
```

## 八、总结
本系统通过模块化与插件化设计，结合 C++17 原生特性与独立版 Asio 异步 IO 模型，实现了一套高性能、高可靠、易扩展的流媒体录制解决方案。系统无 Boost 依赖，支持多协议输入与多存储后端，满足工业级场景下的录制需求，同时提供完善的运维工具与监控能力，降低部署与维护成本。