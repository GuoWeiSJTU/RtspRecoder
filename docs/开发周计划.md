# RTSP流录制系统开发周计划

## 第一周：基础框架搭建（已完成）

### 目标
完成系统核心接口定义和基础架构搭建，建立插件化系统基础，实现RTSP协议插件的框架。

### 已完成任务

1. **核心接口定义**
   - 定义[MediaSource](file:///home/guo/RtspRecorder/include/media_source.h#L17-L45)媒体源接口，包括连接、断开、读取数据包等核心方法
   - 定义[PluginManager](file:///home/guo/RtspRecorder/include/plugin_manager.h#L11-L45)插件管理器接口，支持插件的加载、卸载和创建媒体源实例
   - 定义[RecorderController](file:///home/guo/RtspRecorder/include/recorder_controller.h#L28-L67)录制控制器接口，支持录制的开始、停止、暂停和恢复
   - 定义[StorageManager](file:///home/guo/RtspRecorder/include/storage_manager.h#L25-L51)存储管理器接口，支持多种存储后端的统一管理

2. **插件系统基础**
   - 实现RTSP协议插件基础框架
   - 定义插件导出函数规范（create_source/destroy_source）
   - 建立插件与主程序的交互机制

3. **构建系统**
   - 配置CMakeLists.txt，支持主程序和插件的构建
   - 设置C++17标准和依赖项（Asio、FFmpeg、yaml-cpp、fmt等）

4. **主程序**
   - 实现基础主程序，输出开发进度信息

### 核心代码结构

```
include/
  ├── media_source.h          # 媒体源接口定义
  ├── plugin_manager.h        # 插件管理器接口定义
  ├── recorder_controller.h    # 录制控制器接口定义
  └── storage_manager.h       # 存储管理器接口定义

plugins/
  └── rtsp/                   
    └── rtsp_source.cpp       # RTSP协议插件实现（基础框架）

src/
  ├── core/
  │   └── main.cpp            # 主程序入口
  │   └── config_manager.cpp  # 配置管理器实现
  │   └── recorder_controller.cpp # 录制控制器实现
  └── storage/
      └── local_storage.cpp   # 本地存储后端实现

CMakeLists.txt              # 构建配置文件
```

## 第二周计划

### 目标
实现RTSP协议的完整交互逻辑，开发配置管理模块，实现基本的录制控制功能。

### 计划任务

1. **RTSP协议实现完善**
   - 实现RTSP信令交互（OPTIONS, DESCRIBE, SETUP, PLAY, TEARDOWN）
   - 实现RTP包接收和解析
   - 实现RTCP控制协议处理
   - 支持RTSP认证（Basic/Digest）

2. **配置管理模块**
   - 实现YAML配置文件解析
   - 支持配置热更新机制
   - 实现配置参数验证

3. **录制控制功能**
   - 实现基本录制控制器
   - 支持手动启停录制
   - 实现录制状态管理

4. **本地存储后端**
   - 实现本地文件系统存储后端
   - 支持基本的文件写入操作
   - 实现存储空间监控

## 第三周计划

### 目标
实现媒体处理模块，完善录制策略，开发API服务模块。

### 计划任务

1. **媒体处理模块**
   - 实现音视频同步机制
   - 实现时间戳校准功能
   - 实现解封装功能

2. **录制策略**
   - 实现按时间分段录制
   - 实现按大小分段录制
   - 实现定时录制功能

3. **API服务模块**
   - 实现基于Asio的HTTP服务
   - 实现REST API接口
   - 实现录制控制接口

## 第四周计划

### 目标
实现多协议支持，完善存储管理，开发监控日志模块。

### 计划任务

1. **多协议支持**
   - 实现RTMP协议插件
   - 实现HLS协议插件
   - 完善插件管理机制

2. **存储管理**
   - 实现对象存储后端（S3兼容）
   - 实现混合存储策略
   - 实现文件加密功能

3. **监控日志模块**
   - 实现分级日志系统
   - 实现指标监控功能
   - 实现Prometheus指标导出

## 第五周计划

### 目标
系统集成测试，性能优化，完善文档。

### 计划任务

1. **系统集成**
   - 完成各模块集成
   - 进行端到端测试
   - 修复发现的问题

2. **性能优化**
   - 优化内存使用
   - 优化IO性能
   - 进行压力测试

3. **文档完善**
   - 完善用户手册
   - 完善API文档
   - 完善开发者指南

---

以下是基于软件需求和设计文档制定的原开发周计划（总周期约20周，按模块优先级递进开发）：

| 周数 | 阶段 | 核心任务 | 交付物 | 依赖 |
|------|------|--------------------------------------------------------------------------|---------------------------------------------|----------------------|
| 1 - 2 | 需求分析与设计细化 | 1. 梳理各模块接口定义（MediaSource/StorageSink等）<br>2. 确定插件通信协议与消息总线格式<br>3. 细化异常处理流程（断流重连/文件修复） | 详细接口文档、异常处理流程图 | 需求文档、设计文档 |
| 3 - 5 | 核心框架开发 | 1. 搭建C++17基础工程（CMake配置/Asio初始化）<br>2. 实现插件管理模块（动态加载/版本隔离）<br>3. 开发消息总线与模块通信机制 | 框架工程骨架、PluginManager核心代码 | 无 |
| 6 - 8 | 录制控制模块开发 | 1. 实现Cron表达式解析与定时调度<br>2. 开发分段管理逻辑（时间/大小双阈值）<br>3. 集成.idx索引文件生成功能 | RecorderController模块、分段逻辑单元测试 | 核心框架 |
| 9 - 11 | 存储管理模块开发 | 1. 实现本地SSD缓存写入（std::async异步提交）<br>2. 开发对象存储分片上传（8MB/片）<br>3. 完成混合存储策略调度逻辑 | StorageManager模块、存储适配插件（本地/S3） | 录制控制模块 |
| 12 - 13 | 协议插件开发 | 1. 开发RTSP协议插件（RTP/UDP/TCP支持）<br>2. 实现RTMP/SRT协议插件（基于MediaSource接口）<br>3. 验证多协议输入兼容性 | 协议插件（.so/.dll）、协议测试用例 | 核心框架 |
| 14 - 15 | 编解码与封装模块 | 1. 集成FFmpeg实现媒体封装（MP4/TS）<br>2. 开发编解码插件接口与H.264/H.265支持<br>3. 实现音视频同步逻辑（误差<40ms） | Muxer模块、编解码插件框架 | 协议插件 |
| 16 - 17 | 监控与运维模块 | 1. 开发Prometheus指标暴露（基于std::atomic）<br>2. 实现日志系统（分级/异步落盘）<br>3. 开发运维工具（rtsp - probe/record - repair） | 监控模块、日志模块、运维工具集 | 核心框架 |
| 18 | 集成测试 | 1. 16路并发录制测试（混合协议）<br>2. 异常场景测试（断网/崩溃恢复）<br>3. 插件热更新验证 | 测试报告、问题修复清单 | 所有模块 |
| 19 | 性能优化 | 1. 优化CPU/内存占用（目标：8核支持16路）<br>2. 提升对象存储上传成功率（≥99.9%）<br>3. 降低写盘延迟（≤1s） | 性能优化报告 | 集成测试结果 |
| 20 | 部署与验收 | 1. 编写Dockerfile与部署脚本<br>2. 生成交付物（源码/文档/工具）<br>3. 验收测试（功能/性能/可靠性） | 部署包、验收报告 | 性能优化结果 |

### 关键里程碑
- 第5周：核心框架稳定，支持插件动态加载
- 第11周：存储模块完成，支持混合存储策略
- 第17周：全量功能模块开发完成
- 第20周：通过验收测试，交付最终版本

注：可根据实际开发进度动态调整，预留1 - 2周缓冲时间应对风险（如插件兼容性问题、性能瓶颈）。