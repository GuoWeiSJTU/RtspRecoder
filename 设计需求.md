# 基于 C++17 + 独立版 Asio 的 RTSP 流录制系统 设计需求文档
## 核心目标
**可维护、可扩展、可配置、可容错**，交付一套无 Boost 依赖、基于 C++17 标准（无协程）、独立版 Asio 的工业级流媒体录制系统，支持多协议输入、多存储后端、高并发、易运维与多场景部署。


## 一、总体需求维度
### 1. 功能需求
#### 1.1 协议支持（扩展为多源输入框架）
- **核心协议**：兼容标准 **RTSP 1.0/1.1/2.0**，传输层强制支持 **RTP/UDP** 与 **RTP/TCP** 双模式，支持自动协商与故障回退（UDP 连接失败时自动切换 TCP）。
- **多协议扩展**：基于插件化架构支持 RTMP（RTMPS）、HLS（HTTP Live Streaming）、SRT（Secure Reliable Transport）协议输入，插件通过 `dlopen`/`LoadLibrary` 动态加载，无需重新编译主程序。
- **统一抽象接口**：所有输入协议实现 `MediaSource` 抽象接口（含 `connect()`/`disconnect()`/`read_packet()`/`get_metadata()` 方法），核心模块通过接口交互，与具体协议解耦。
- **认证与加密**：RTSP 支持 Digest 认证（必选）、Basic 认证（可选）；RTMP 支持复杂握手与 Token 认证；SRT 支持加密传输（AES-128/256）；可选支持所有协议的 TLS 加密传输（基于独立版 Asio SSL 模块）。
- **自动解析**：自动解析 SDP（RTSP）、FLV Tag（RTMP）、M3U8（HLS）、SRT 元数据，提取音视频编码格式、码率等信息，无需手动配置。

#### 1.2 媒体支持（插件化编解码扩展）
- **视频**：必选支持 H.264（Main/High profile）、H.265（Main/High profile），最高适配 4K@60 fps；通过插件扩展支持 VP9、AV1、H.266（VVC）等新格式（插件需实现 `CodecInterface` 接口）。
- **音频**：必选支持 AAC-LC、G.711A/μ、Opus，采样率兼容 8/16/32/44.1/48 kHz；通过插件扩展支持 AC-3、E-AC-3、FLAC 等格式，支持音频原样录制或转码（转码策略可配置）。
- **录制模式**：支持「音视频同步录制」「仅录视频」「仅录音频」三种模式切换，音视频同步基于协议时间戳（RTP 时间戳、RTMP 时间戳等）与时钟校准，同步误差 <40 ms。

#### 1.3 录制策略
- 基础控制：支持 **手动启停**（API 触发）、**按计划启停**（cron 表达式配置）、**自动分段**（按文件时长/大小，可配置阈值）。
- 高级策略：支持「掉线补录」（可选，依赖源服务器回放能力，恢复后自动补充中间缺失片段）；支持「循环录制」（配置最大存储容量/文件数，空间不足时自动覆盖最早文件，默认禁用）。

#### 1.4 存储格式（多存储后端扩展）
- **容器格式**：支持 MP4、MKV、TS 动态切换（通过 `MuxerFactory` 按配置创建对应封装器，无需重启）；默认推荐 TS（兼容流式存储）与 MP4（支持索引拖拽）。
- **多存储后端**：抽象 `StorageSink` 接口，实现以下存储适配：
  - 本地文件系统：EXT4、XFS、NTFS（支持文件权限控制与磁盘配额）；
  - 对象存储：兼容 S3 API（AWS S3、MinIO）、阿里云 OSS、腾讯云 COS（支持分片上传与生命周期管理）；
  - NAS 存储：NFS v3/v4、SMB 3.0（支持挂载点健康检测与故障切换）。
- **混合存储策略**：支持「本地缓存 + 云端归档」模式：实时录制先写入本地 SSD（低延迟，缓存大小可配置），空闲时通过异步任务上传至对象存储，同时保留 `.idx` 索引文件（记录云端片段位置与元数据）用于快速定位。
- **文件可靠性**：录制文件支持异常中断（崩溃、断电）后修复，通过 moov/mdat 结构优化或 `.idx` 索引文件，确保可恢复时长 ≥95%，支持第三方修复工具兼容。
- **编码策略**：视频默认保持原始编码（无转码损耗），可配置基于插件的转码（如 H.265 转 H.264）；音频可配置「原样保留」或「转码为 AAC」。

#### 1.5 实时预览（可选）
- 提供 1 路低延迟预览流，支持两种输出方式：RTSP over TCP 转发、本地共享内存（YUV 格式）；预览延迟 <300 ms，不影响主录制流性能。

### 2. 性能与资源需求
- **并发能力**：单机支持 ≥16 路 1080p@30 fps 同时录制（8 核 2.4 GHz CPU 环境），CPU 占用 ≤70%；支持扩展至 32 路（16 核 CPU）。
- **内存占用**：每路录制峰值内存 ≤150 MB；8 路并发总内存 ≤1.2 GB，无内存泄漏（72 小时运行内存增长 ≤5%）。
- **IO 性能**：本地存储缓存写盘延迟 ≤1 s（缓存大小可配置 16KB~4MB）；对象存储上传支持并发分片（默认 4 线程），上传成功率 ≥99.9%（网络正常时）。
- **码率与存储**：提供实时码率预估功能，结合各存储后端剩余空间计算可录制时长；支持剩余空间预警（配置阈值触发告警）。

### 3. 可靠性与容错
- 网络适应性：网络抖动 5% 无花屏、无卡顿；丢包率 1% 时，帧丢失率 ≤0.5%，音视频同步误差 <40 ms。
- 断流重连：任意输入协议连接中断时（网络断开、服务器重启），自动重连（重连间隔 1~30 秒可配置，默认 3 秒；重连次数无限制），重连成功后无缝续录。
- 文件完整性：进程崩溃、断电等异常场景下，已生成文件可正常播放，未完成文件可通过工具或下次启动自动修复，可恢复时长 ≥95%。
- 热升级支持：支持动态替换协议插件、编解码插件、存储插件（so/dll），不中断正在进行的录制任务（通过共享对象版本号与双缓冲机制实现）。

### 4. 运维与可观测性
- 日志系统：支持 TRACE/DEBUG/INFO/WARN/ERROR 五级分级，基于 C++17 `constexpr` 优化；支持异步落盘、控制台输出、syslog 转发，日志格式含时间戳、模块名、流 ID、详细上下文。
- 指标监控：暴露 Prometheus 文本格式指标，核心指标包括：单路/总码率、帧率、丢包数、各存储后端剩余空间、录制状态、重连次数、文件大小、插件加载状态等；支持指标周期采集（10s~60s 可配置）。
- 接口支持：提供 HTTP REST API（JSON 格式）与 gRPC 双协议接口，支持录制启停、状态查询、补录触发、文件删除、配置查询、插件管理（加载/卸载）等操作（基于独立版 Asio 实现网络服务）。

### 5. 配置与部署需求
- 配置方式：采用单文件 YAML 配置，支持 **动态热更新**（无需重启进程），可热更新项包括：录制策略、存储路径/后端参数、日志级别、协议超时、告警阈值、预览开关、插件加载列表。
- 容器化部署：提供轻量化 Dockerfile 与 docker-compose 配置，镜像体积 ≤60 MB；支持 Kubernetes DaemonSet/Deployment 部署，适配容器编排生命周期管理。
- 跨平台兼容：支持 64 位操作系统：Linux（Ubuntu 18.04+、CentOS 7+、麒麟 V10）、Windows Server 2016+、macOS 10.15+（开发环境）。

### 6. 安全合规需求
- 身份认证：输入协议支持各自的认证机制（RTSP Digest、RTMP Token 等），用户名/密码加密存储（对接 KMS 或 Base64 编码，禁止明文）；对外 API 启用 TLS 1.3 加密（基于独立版 Asio SSL 模块），支持证书自动轮转。
- 数据加密：录制文件默认支持 AES-128-CBC 加密，密钥由 KMS 下发；可选支持国密 SM4 加密算法，加密开关可配置。
- 输入校验：严格校验协议地址、端口、存储路径权限、配置参数合法性（如分片大小 ≥1MB、端口 1~65535），非法参数直接拒绝并记录错误日志。


## 二、模块划分与职责
采用 **模块化解耦设计**，模块间通过「线程安全消息总线」（C++17 `std::any` + `std::function` + 无锁队列）通信，支持独立单元测试与插件化替换，全程无 Boost 依赖，基于独立版 Asio 实现网络功能。

| 模块名称               | 核心职责                                                                 | C++17 特性应用                                                                 |
|------------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------|
| **MediaSourceManager** | 多协议输入管理，`MediaSource` 接口定义，协议插件加载/卸载/生命周期管理，协议类型自动识别与适配 | `std::shared_ptr`（插件资源管理）、`std::function`（插件回调）、`std::filesystem`（插件路径扫描） |
| **RtspSource**（插件） | RTSP 信令交互（独立版 Asio TCP）、RTP 包接收（独立版 Asio UDP）、FEC 重传、认证处理、传输模式切换 | `std::atomic`（连接状态）、`std::shared_mutex`（配置读写）、`std::function`（异步回调）、`std::chrono`（超时控制） |
| **OtherProtocolSource**（插件，如RtmpSource） | 特定协议（RTMP/HLS/SRT）的连接管理、数据接收、协议解析，实现 `MediaSource` 接口 | `std::variant`（多协议数据封装）、`std::span`（高效数据读写）、`std::chrono`（心跳与超时） |
| **DemuxerCore**        | 协议数据解封装（RTP/RTMP/HLS/SRT 包 → AVPacket）、时间戳校准、音视频同步、丢包补偿 | `std::variant`（存储不同类型媒体包）、`std::chrono`（时间戳计算）、`std::optional`（可选元数据）、结构化绑定（解析元数据） |
| **CodecManager**       | 编解码插件管理，`CodecInterface` 接口定义，编码/解码能力注册与匹配，转码任务调度 | `std::map`（插件能力映射）、`std::unique_ptr`（编解码器实例）、`std::future`（异步转码） |
| **RecorderController** | 录制策略调度、启停控制、分段管理、补录触发、异常恢复、热升级协调           | `std::filesystem`（文件路径管理）、`std::function`（回调注册）、`std::mutex`（策略同步） |
| **StorageManager**     | 多存储后端管理，`StorageSink` 接口定义，存储插件加载，本地/云端存储切换与协同 | `std::shared_ptr`（存储实例）、`std::condition_variable`（上传任务同步）、`std::chrono`（上传重试计时） |
| **Muxer & FileSink**   | 容器封装（MP4/MKV/TS，通过 `MuxerFactory` 动态创建）、文件写入、缓存管理、加密处理、异常文件修复 | `std::unique_ptr`（资源自动释放）、`std::aligned_alloc`（内存对齐）、`constexpr`（格式常量）、`std::async`（异步写盘/上传） |
| **Config/Log/Metrics Mgr** | 配置热加载、日志分级输出、指标采集与暴露、告警触发、syslog 转发           | `std::filesystem`（配置文件监控）、`std::string_view`（日志字符串优化）、`std::atomic`（指标累计） |
| **PreviewModule**（可选） | 低延迟预览流生成、共享内存/YUV 输出、预览延迟控制                         | `std::shared_memory_object`（共享内存）、`std::chrono::steady_clock`（延迟统计）、`std::mutex`（预览流同步） |
| **ApiServer**          | REST API/gRPC 接口实现（独立版 Asio TCP）、TLS 加密、请求校验、响应序列化 | `std::any`（接口参数封装）、`std::mutex`（接口并发控制）、`std::stringstream`（响应序列化） |


## 三、关键技术点与 C++17 选型（无 Boost，独立 Asio）
### 1. 网络与并发（独立版 Asio 核心应用）
- 异步网络模型：基于独立版 Asio 的「回调式异步 IO」，RTSP/RTMP 等信令使用 `asio::ip::tcp::socket` + `asio::streambuf` 处理请求/响应，RTP/UDP/SRT 接收使用 `asio::ip::udp::socket` 或自定义传输层异步接收，通过 `std::function` 注册完成回调，避免阻塞。
- 超时控制：通过 `asio::steady_timer` 实现各协议连接超时、数据接收超时，结合 `std::chrono::milliseconds` 配置超时阈值（可热更新）。
- 线程模型：每路流分配独立的「Asio IO 上下文 + 工作线程」，核心模块共享线程池（`std::thread` 数组），避免单线程瓶颈，支持线程优先级配置。
- 无锁队列：采用 moodycamel::ConcurrentQueue 作为 AVPacket 缓存通道，实现生产者（DemuxerCore）与消费者（Muxer）解耦，保证高并发下的性能。

### 2. 插件化架构（扩展性核心实现）
- 协议插件机制：定义 `MediaSource` 纯虚接口（含 `connect()`/`read_packet()` 等方法），插件通过 `extern "C"` 导出 `create_source()`/`destroy_source()` 函数，主程序通过 `dlopen` 加载并调用，插件元数据（支持协议类型、版本、作者）通过 `std::map<std::string, Metadata>` 注册至 `MediaSourceManager`。
- 编解码插件机制：`CodecInterface` 接口定义 `encode()`/`decode()`/`get_supported_formats()` 方法，插件实现具体编码（如 AV1 编码）或解码逻辑，`CodecManager` 根据媒体格式动态匹配最优插件，通过 `std::unique_ptr<CodecInterface>` 管理实例生命周期。
- 存储插件机制：`StorageSink` 接口定义 `write()`/`read()`/`delete()`/`get_free_space()` 方法，本地/对象存储/NAS 分别实现接口，`StorageManager` 根据配置选择单存储或混合存储模式，通过 `std::shared_ptr<StorageSink>` 实现多存储协同。
- 插件热更新：通过「版本号隔离」实现，新插件加载后生成新实例，旧实例在当前文件分片完成后通过 `std::unique_ptr` 自动释放，消息总线动态切换至新实例，避免资源竞争。

### 3. 内存与资源管理（C++17 原生优化）
- 智能指针封装：自定义 AVPacket/AVFrame 的 `std::unique_ptr` 包装器，通过自定义删除器自动调用 `av_packet_free`/`av_frame_free`，避免内存泄漏。
- 内存对齐：使用 `std::aligned_alloc` 分配 32 字节对齐的媒体缓存，兼容 SIMD 优化，提升解封装与封装效率。
- 配置读写安全：采用「读多写少」模型，用 `std::shared_mutex` 保护配置数据，热更新时写锁独占，读取时共享锁并发，不阻塞业务流程。

### 4. 媒体处理与同步（无协程依赖）
- 时间戳校准：以各协议时钟（RTCP Sender Report NTP 时间、RTMP 绝对时间戳等）为基准，通过 `std::chrono::duration` 转换为统一时间轴，确保多协议输入的时间戳一致性。
- 音视频同步：基于统一时间轴差值动态调整播放顺序，同步误差通过 `std::atomic` 原子更新，避免线程竞争导致的同步错乱。
- 容器封装优化：MP4 格式采用「渐进式 moov 写入」，实时更新索引信息；TS 格式按包流式写入，依赖 PCR 时钟保证异常后可恢复；封装器通过 `MuxerFactory` 动态创建，支持运行时切换（如从 MP4 切换为 MKV）。

### 5. 多存储与文件管理（高可靠设计）
- 混合存储实现：实时录制时，`StorageManager` 优先调用本地 `StorageSink` 写入 SSD 缓存（`std::async` 异步提交），空闲时触发云端 `StorageSink` 上传（通过 `std::thread` 池化处理），`.idx` 索引文件同时记录本地与云端片段映射关系（JSON Lines 格式）。
- 异常文件修复：录制时同步生成 `.idx` 索引文件，记录每帧 offset、size、PTS、关键帧标记；异常后通过索引重建 moov/mdat 结构（本地文件）或重新拼接云端分片（对象存储），恢复文件完整性。
- 加密实现：基于标准库与开源加密库（如 OpenSSL）实现 AES-128-CBC/SM4 加密，密钥通过 `std::unique_ptr` 管理，避免内存中明文泄露。
- IO 优化：本地存储采用「缓存+批量写盘」策略，缓存大小可配置（16KB~4MB）；对象存储采用分片上传（默认 8MB/片）与断点续传，通过 `std::future` 跟踪上传状态，失败自动重试（最多 3 次）。

### 6. 热更新与容错（无 Boost 依赖）
- 热升级机制：通过「双缓冲+版本号管理」实现插件替换，新插件加载后通过消息总线平滑切换，旧插件在当前文件分片完成后通过 `std::unique_ptr` 自动释放资源。
- 断流恢复：断流时保存当前录制上下文（文件偏移、时间戳、未写入缓存、存储后端状态），存储在 `std::tuple` 中，重连成功后基于上下文无缝续录，不生成新文件。
- 网络容错：RTP/RTMP/SRT 丢包时通过「前后帧插值」「关键帧请求重传」补偿，结合 `std::atomic` 统计丢包数，触发告警阈值时通知运维。

### 7. 可观测性实现（轻量无依赖）
- 日志系统：基于 fmt::format（轻量无 Boost 依赖）实现分级日志，结合 C++17 `constexpr` 优化日志级别判断；异步落盘使用 `std::queue` + 独立写线程，通过 `std::condition_variable` 触发写操作。
- 指标暴露：基于 `std::stringstream` 生成 Prometheus 文本格式指标，包含插件加载状态、各存储后端使用率等扩展指标；通过独立版 Asio 实现 HTTP 服务暴露指标，指标采集采用 `std::atomic` 累计，避免锁竞争。


## 四、对外接口与配置
### 1. 配置规范（YAML 格式，无 Boost 依赖）
支持单文件配置与热更新，核心配置项示例（使用 yaml-cpp 解析，无 Boost 依赖）：
```yaml
global:
  log_level: INFO               # 支持 TRACE/DEBUG/INFO/WARN/ERROR
  log_path: /var/log/stream-recorder/
  syslog_enable: true           # 启用 syslog 转发
  metrics_port: 9090            # Prometheus 指标端口
  api_port: 8080                # REST API 端口
  grpc_port: 50051              # gRPC 端口
  tls_enable: true              # 启用 TLS 1.3（独立版 Asio SSL）
  tls_cert: /etc/certs/server.crt
  tls_key: /etc/certs/server.key
  plugin_path: /usr/lib/stream-recorder/plugins/  # 插件目录

# 多协议输入配置
protocols:
  default_transport: auto       # 默认传输模式（auto/tcp/udp）
  timeout: 10                   # 连接超时（秒）
  reconnect_interval: 3         # 重连间隔（秒）
  enabled_plugins:              # 启用的协议插件
    - rtsp_plugin.so
    - rtmp_plugin.so
    - srt_plugin.so

# 编解码配置
codec:
  video_strategy: copy          # 视频编码策略（copy/transcode）
  audio_strategy: copy          # 音频编码策略（copy/aac/opus）
  enabled_codec_plugins:        # 启用的编解码插件
    - av1_decoder.so
    - h266_encoder.so

# 多存储后端配置
storage:
  default_backend: local        # 默认存储后端（local/s3/nfs）
  local:                        # 本地存储配置
    path: /data/recordings/
    cache_size: 2048            # 写盘缓存（KB）
  s3:                           # S3 兼容对象存储配置
    endpoint: http://minio:9000
    access_key: AKIAEXAMPLE
    secret_key: secret
    bucket: recordings
    upload_threads: 4           # 上传线程数
  nfs:                          # NAS（NFS）配置
    mount_point: /mnt/nfs-recordings
    health_check_interval: 60   # 健康检测间隔（秒）
  hybrid_mode: true             # 启用本地缓存+云端归档混合模式
  hybrid_upload_delay: 300      # 本地缓存后延迟上传时间（秒）

# 录制策略配置
recorder:
  default_format: mp4           # 默认容器格式（mp4/mkv/ts）
  segment_duration: 300         # 分段时长（秒），优先于大小
  segment_size: 1024            # 分段大小（MB）
  loop_record: false            # 禁用循环录制
  free_space_warn: 10           # 剩余空间预警阈值（GB）
  encrypt_mode: aes-128-cbc     # 加密模式（none/aes-128-cbc/sm4）
  kms_key_url: http://kms-server/v1/key

# 预配置流列表（支持动态添加）
streams:
  - stream_id: camera_001
    source_url: rtsp://user:pass@192.168.1.100:554/stream1  # 自动识别协议类型
    record_mode: audio_video    # 录制模式（audio_video/video/audio）
    schedule: "0 0 * * *"       # 每日 0 点启动录制
    segment_duration: 1800      # 单流独立分段时长（30 分钟）
    storage_backend: s3         # 该流使用 S3 存储（覆盖全局默认）
  - stream_id: encoder_001
    source_url: srt://192.168.1.200:9000?encryption=yes  # SRT 协议
    record_mode: video
    format: ts                  # 容器格式为 TS
    codec:
      video_strategy: transcode  # 该流启用视频转码
      target_video_codec: h264   # 转码目标格式 H.264
```

### 2. 对外接口示例（基于独立版 Asio）
#### 2.1 REST API（POST 启动录制，支持多协议）
```http
POST /api/v1/record/start
Content-Type: application/json
Authorization: Bearer {token}

{
  "stream_id": "encoder_002",
  "source_url": "rtmp://192.168.1.101/live/stream2",  # RTMP 协议
  "record_mode": "video",
  "format": "mkv",
  "segment_duration": 600,      # 10 分钟分段
  "segment_size": 512,          # 最大 512 MB 分段
  "storage_backend": "hybrid",  # 使用混合存储模式
  "codec": {
    "audio_strategy": "aac"     # 音频转码为 AAC
  },
  "encrypt_mode": "none"
}

# 响应（201 Created）
{
  "code": 0,
  "msg": "success",
  "data": {
    "handle": "uuid-deadbeef-1234-5678-90ab-cdef01234567",
    "start_time": "2025-11-09T14:30:00Z",
    "estimated_bitrate": 4096,  # 预估码率（Kbps）
    "protocol": "rtmp",         # 自动识别的协议类型
    "storage_backend": "hybrid"
  }
}
```

#### 2.2 REST API（插件管理）
```http
POST /api/v1/plugins/load
Content-Type: application/json
Authorization: Bearer {token}

{
  "plugin_path": "/usr/lib/stream-recorder/plugins/hls_plugin.so"
}

# 响应（200 OK）
{
  "code": 0,
  "msg": "plugin loaded successfully",
  "data": {
    "plugin_name": "hls_plugin",
    "version": "1.0.0",
    "supported_protocols": ["hls", "hls-https"]
  }
}
```

#### 2.3 Prometheus 指标示例（含扩展指标）
```
# HELP stream_record_bitrate_bps 单路流录制码率（bps）
# TYPE stream_record_bitrate_bps gauge
stream_record_bitrate_bps{stream_id="camera_001",protocol="rtsp"} 4194304
stream_record_bitrate_bps{stream_id="encoder_001",protocol="srt"} 3670016

# HELP stream_record_frame_loss_count 累计丢帧数
# TYPE stream_record_frame_loss_count counter
stream_record_frame_loss_count{stream_id="camera_001",protocol="rtsp"} 5

# HELP storage_free_space_gb 各存储后端剩余空间（GB）
# TYPE storage_free_space_gb gauge
storage_free_space_gb{backend="local",path="/data/recordings"} 235
storage_free_space_gb{backend="s3",bucket="recordings"} 1500
storage_free_space_gb{backend="nfs",mount_point="/mnt/nfs-recordings"} 800

# HELP plugin_status 插件状态（0:未加载,1:加载中,2:正常,3:异常）
# TYPE plugin_status gauge
plugin_status{plugin_name="rtsp_plugin",type="protocol"} 2
plugin_status{plugin_name="av1_decoder",type="codec"} 2
plugin_status{plugin_name="s3_sink",type="storage"} 2

# HELP stream_record_status 录制状态（0:未启动,1:录制中,2:暂停,3:重连中）
# TYPE stream_record_status gauge
stream_record_status{stream_id="camera_001",storage_backend="s3"} 1
```

#### 2.4 配置热更新触发
```bash
# 发送 USR1 信号触发配置热更新
kill -USR1 <recorder_pid>

# 热更新日志输出
2025-11-09 14:35:00 [INFO] [ConfigMgr] Received SIGHUP, reloading config.yaml
2025-11-09 14:35:00 [INFO] [ConfigMgr] Update log_level from INFO to DEBUG
2025-11-09 14:35:00 [INFO] [ConfigMgr] Enable new protocol plugin: hls_plugin.so
2025-11-09 14:35:00 [INFO] [StorageManager] Update hybrid_upload_delay from 300 to 600
2025-11-09 14:35:00 [INFO] [ConfigMgr] Config reload success, no impact on running recordings
```

### 3. 部署与编译（无 Boost 依赖）
- 编译依赖：C++17 编译器（GCC 7+/Clang 5+/MSVC 2017+）、独立版 Asio（1.28.0+）、FFmpeg 5.0+（libavformat/libavcodec）、yaml-cpp 0.7.0+、fmt 8.0+、OpenSSL 1.1.1+（TLS）、moodycamel::ConcurrentQueue、libdl（插件加载，Linux）。
- CMake 配置：明确链接独立版 Asio，禁用 Boost 相关依赖，支持插件编译与安装，示例片段：
  ```cmake
  find_package(asio REQUIRED)
  find_package(FFmpeg REQUIRED)
  find_package(yaml-cpp REQUIRED)
  # 主程序编译
  add_executable(stream-recorder src/main.cpp ...)
  target_link_libraries(stream-recorder 
    PRIVATE asio::asio 
            FFmpeg::avformat FFmpeg::avcodec FFmpeg::avutil
            yaml-cpp fmt ssl crypto pthread dl
  )
  target_compile_features(stream-recorder PRIVATE cxx_std_17)
  # 协议插件编译（RTSP示例）
  add_library(rtsp_plugin SHARED plugins/rtsp_source.cpp)
  set_target_properties(rtsp_plugin PROPERTIES PREFIX "")  # 生成 rtsp_plugin.so 而非 librtsp_plugin.so
  target_link_libraries(rtsp_plugin PRIVATE asio::asio FFmpeg::avutil)
  # 安装插件至指定目录
  install(TARGETS rtsp_plugin rtmp_plugin s3_sink_plugin
          DESTINATION /usr/lib/stream-recorder/plugins)
  ```
- Docker 镜像：基于 Alpine Linux 构建，仅包含核心依赖与插件目录，镜像体积 ≤60 MB，避免 Boost 带来的体积膨胀。


## 五、交付与验收标准
1. 功能验收：满足所有功能需求，16 路 1080p@30 fps 并发录制（含 RTSP/RTMP/SRT 混合协议）无卡顿，文件修复成功率 ≥95%；插件化架构支持动态加载/卸载协议、编解码、存储插件，无需重启主程序；无任何 Boost 依赖，编译时不链接 Boost 库。
2. 性能验收：8 核 2.4 GHz CPU 环境下，16 路并发录制 CPU 占用 ≤70%，每路内存 ≤150 MB，本地写盘延迟 ≤1 s，对象存储上传成功率 ≥99.9%；独立版 Asio 异步 IO 无明显瓶颈。
3. 可靠性验收：7x24 小时连续运行无崩溃，内存泄漏 ≤5%；断网 10 分钟恢复后无缝续录，无文件断裂；热更新配置与插件不影响正在进行的录制任务。
4. 交付物：
   - 源代码（含核心模块与插件示例）、单元测试、CMake 编译脚本；
   - 协议插件（RTSP/RTMP/SRT）、编解码插件（AV1 示例）、存储插件（S3 示例）；
   - Dockerfile、docker-compose.yml、K8s 部署清单；
   - 设计说明书、用户操作手册、运维手册、API 文档、插件开发指南；
   - `record-repair` 文件修复工具、性能测试脚本（无 Boost 依赖）。
5. 部署环境：支持 Ubuntu 20.04/22.04、CentOS 8、麒麟 V10，容器化部署支持 Kubernetes 1.20+。


## 总结
本设计需求严格遵循「无 Boost 依赖、C++17 标准、独立版 Asio、无协程」的约束，通过**插件化架构**增强扩展性（多协议输入、多存储后端、动态编解码），结合模块化解耦、C++17 原生特性优化、独立版 Asio 异步 IO 实现，确保系统满足「可维护、可扩展、可配置、可容错」的核心目标。开发团队可基于此需求直接进入概要设计与详细设计阶段，按「核心框架（MediaSource/StorageSink 接口）→ 基础插件（RTSP/本地存储）→ 扩展插件（RTMP/S3）→ 运维工具 → 部署验证」的优先级推进，预计 4~5 个月可完成交付。